syntax = "proto3";

package gamarjoba;

import "users.proto";

message ChatBadge {
  string chatId = 1;
  uint64 badge = 2;
}

enum ChatType {
  UNKNOWN_CHAT_TYPE = 0;
  DIRECT = 1;
  GROUP = 2;
  TASK = 3;
}

message ChatPreview {
  string id = 1;
  //  ChatType chatType = 2;
  //  Icon icon = 3;
  //  string displayName = 4;
}

message Message {
  ChatPreview chat = 8;
  string id = 1;
  uint64 createdAt = 3;
  uint64 updatedAt = 9; // non-empty if message was changed
  string text = 4;
  User sender = 5;
  string prevMessageId = 6;
  uint64 viewedCounter = 7; // how many recipients viewed this message

  enum Right {
    UNKNOWN_RIGHT = 0;
    CAN_EDIT = 1;
    CAN_DELETE = 2;
  }
  repeated Right rights = 10;
}

message ViewedMessage {
  string messageId = 1;
  string chatId = 2;
  uint64 viewedCounter = 3; // how many recipients viewed this message
}

message SendMessageRequest {
  string id = 4; // optional
  oneof recipient {
    string chatId = 2;
    string userId = 1;
  }
  string text = 3;
}

message SendMessageResponse {
  enum Error {
    UNKNOWN_ERROR = 0;
    INVALID_MESSAGE_ID_ERROR = 1;
    INVALID_RECIPIENT_ERROR = 2;
    MESSAGE_TEXT_TOO_LONG_ERROR = 3;
    MESSAGE_IS_EMPTY_ERROR = 4;
  }
  repeated Error errors = 1;

  Message message = 2;
}

message MessagesListRequest {
  oneof recipient {
    string chatId = 2;
    string userId = 1;
  }

  enum Mode {
    LATEST = 0; // open chat
    NEW_FROM_GIVEN_TIME = 1; // scroll down
    OLD_FROM_GIVEN_TIME = 2; // scroll up
    OLD_AND_NEW_AROUND_GIVEN_TIME = 3; // open random message in the middle of history
  }
  Mode mode = 3;

  uint64 createdAt = 4;
  uint32 limit = 5; // default: GetStateResponse.maxResultsOnPage
}

message MessagesListResponse {
  enum Error {
    UNKNOWN_ERROR = 0;
    INVALID_RECIPIENT_ERROR = 1;
  }
  repeated Error errors = 1;

  repeated Message messages = 2;
}

message MessageDetailsRequest {
  string id = 1;
}

message MessageDetailsResponse {
  enum Error {
    UNKNOWN_ERROR = 0;
    INVALID_MESSAGE_ID_ERROR = 1;
  }
  repeated Error errors = 1;
  Message message = 2;
}

message ViewMessageRequest {
  string id = 1;
}

message ViewMessageResponse {
  enum Error {
    UNKNOWN_ERROR = 0;
    INVALID_MESSAGE_ID_ERROR = 1;
  }
  repeated Error errors = 1;
  uint64 badge = 2;  // number of unseen messages
  repeated ViewedMessage viewedMessages = 3; // viewed messages list
}

message MessageViewersRequest {
  string id = 1;
}

message MessageViewersResponse {
  enum Error {
    UNKNOWN_ERROR = 0;
    INVALID_MESSAGE_ID_ERROR = 1;
  }
  repeated Error errors = 1;
  repeated User users = 3;
}
